---
- name: Install dependencies
  apt:
    name: [apt-transport-https, ca-certificates, curl, gnupg, lsb-release, openssl]
    state: present
    update_cache: yes

- name: Import HashiCorp GPG key
  apt_key:
    url: https://apt.releases.hashicorp.com/gpg
    state: present

- name: Add HashiCorp APT repository
  apt_repository:
    repo: "deb [arch=amd64] https://apt.releases.hashicorp.com {{ ansible_distribution_release | lower }} main"
    state: present
    update_cache: yes

- name: Install Vault
  apt:
    name: vault
    state: latest
    update_cache: yes

- name: Create vault user and directories
  block:
    - name: Create vault user
      user:
        name: vault
        shell: /usr/sbin/nologin

    - name: Create directories
      file:
        path: "{{ item }}"
        state: directory
        owner: vault
        group: vault
        mode: '0750'
      loop:
        - /etc/vault
        - /opt/vault/data-main

- name: Create Vault configuration file
  copy:
    dest: /etc/vault/config-main.hcl
    content: |
      storage "file" {
        path = "/opt/vault/data-main"
      }

      listener "tcp" {
        address     = "0.0.0.0:8200"
        tls-disable = 1
      }

      ui = true
    owner: vault
    group: vault
    mode: '0640'
  notify: Restart Vault

- name: Create systemd service for Vault
  copy:
    dest: /etc/systemd/system/vault-main.service
    content: |
      [Unit]
      Description=Vault server (main)
      Requires=network-online.target
      After=network-online.target

      [Service]
      User=vault
      Group=vault
      ExecStart=/usr/bin/vault server -config=/etc/vault/config-main.hcl
      ExecReload=/bin/kill -HUP $MAINPID
      KillMode=process
      Restart=on-failure
      LimitNOFILE=65536

      [Install]
      WantedBy=multi-user.target
  notify: Restart Vault

- name: Enable and start Vault service
  systemd:
    name: vault-main
    enabled: yes
    state: started

- name: Enable UFW and allow Vault port
  ufw:
    rule: allow
    port: '8200'
    proto: tcp
  tags: firewall
